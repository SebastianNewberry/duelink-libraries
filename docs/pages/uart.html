<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>DUELink Template</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="navbar-brand">
            <svg id="logo" class="h-6 w-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 266" preserveAspectRatio="xMidYMid meet" aria-hidden="true" style="display: block; transform: scale(1,-1); width: 100px; height: auto;">
                <g transform="translate(0, 400) scale(1, -1) rotate(0 0 0)" fill="grey" stroke="none">
                    <path d="M1132.1,156.6H643.8c0,0,0-0.1,0-0.1H137c-28.8,59.1-38.2,119.4-23.4,181.1l103.8,0
				c71.1,0,87.3-132.9-0.2-118.4l-16.7,81.5l-39.4,0.2l21-109.1l2.3-0.6c195-39.1,160.1,179.8,29.1,179.4l-89.5,0.3
				c3.7,9.8,8,19.6,13,29.4h506.7c0-0.1,0.1-0.2,0.1-0.3h486.7c19.4-37,30.4-78.9,30.4-123.2C1161,233.7,1150.6,192.9,1132.1,156.6z
				 M477.3,313.7c-15.6,82.2-149.3,72.5-137.2-0.5l20.6-124h40.5l-19.3,103.4c-11.2,60.1,50.4,60.4,59.6,11.8l21.9-115.2H501
				L477.3,313.7z M617.9,334.3l-7.5,34.7H501l21.1-109.4h102.3l-6.8,32.9h-62.9l-8.4,41.8H617.9z M672,223.5H528.4l6.8-34.3
				l143.2-0.2L672,223.5z M779.5,371.3h-98.9L712,189.1h35.3l-25.5,148.1h63.6L779.5,371.3z M833.9,371.3h-35.3l22.8-132.2h35.3
				L833.9,371.3z M843.5,222.7h-0.2c-9.6,0-16.9-7.3-16.9-18.9c0.2-13.2,9.6-22.2,20.4-22.2c10.3,0,17.7,7.6,17.7,19.2
				C864.4,214.5,854.8,222.7,843.5,222.7z M985.6,294.6l-13.3,76.8H937l12.5-73.3c0.7-4.6,1.2-10,1.2-14.9c0-9.2-2.9-15.7-11.8-15.7
				c-11.5,0-25,15.9-29.9,45.1L899,371.3h-35.3l15.2-89.2c2.9-16.8,4.9-31.4,6.4-43h31.4l-2.5,21.9h0.5
				c11.3-17.3,26.3-24.9,42.2-24.9c19.6,0,30.7,13.2,30.7,36C987.6,278.1,986.6,288.1,985.6,294.6z M1117.9,371.3h-39.3l-21.1-56.5
				l-13.3,14.1l-7.4,42.4h-35.1l32.9-191.9h35.1l-19.6,114.9h0.5c3.7-5.1,7.4-10.3,10.8-15.1l30.7-40h43.4l-51,54.3L1117.9,371.3z" />
                </g>
            </svg>
            <span class="navbar-brand-text">DUELink UART</span>
        </div>
    </nav>

    <div id="id-connect" class="alert alert-primary" role="alert">
        <span>
            <svg class="align-middle mr-2" focusable="false" width="24" height="24" aria-hidden="true">
                <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20, 12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10, 10 0 0,0 22,12A10, 10 0 0,0 12,2M11,17H13V11H11V17Z">
                </path>
            </svg>
        </span>
        Press
        <button class="btn btn-outline-primary ml-1 mr-1" onclick="connect()">
            <span>
                <svg class="align-middle" focusable="false" width="24" height="24" aria-hidden="true">
                    <path d="M15 7v4h1v2h-3V5h2l-3-4-3 4h2v8H8v-2.07c.7-.37 1.2-1.08 1.2-1.93 0-1.21-.99-2.2-2.2-2.2-1.21 0-2.2.99-2.2 2.2 0 .85.5 1.56 1.2 1.93V13c0 1.11.89 2 2 2h3v3.05c-.71.37-1.2 1.1-1.2 1.95 0 1.22.99 2.2 2.2 2.2 1.21 0 2.2-.98 2.2-2.2 0-.85-.49-1.58-1.2-1.95V15h3c1.11 0 2-.89 2-2v-2h1V7h-4z">
                    </path>
                </svg>
            </span>
        </button>
        to connect to your device
    </div>

    <div id="id-selections" class="container">
		<div class="row">	
			<div class="center">				
				<div style="border: solid 1px; padding: 0.5em; margin-top:0.5em; " >							
								
					<tr>
						<td width="109">Enable Baudrate:</td><br>
						<td width="97">
							<select id="id-baudrate" onchange="doUartInit()" disabled="true">
								<option value="9600">9600</option>
								<option value="19200">19200</option>
								<option value="38400">38400</option>
								<option value="57600">57600</option>
								<option value="115200">115200</option>
								<option value="230400">230400</option>
								<option value="460800">460800</option>
								<option value="921600">921600</option>
							</select>
						</td>
					</tr>
					<br>
					<tr>						
						<label for="dataSend">Byte(s) to send: (0,1,2... 255)</label><br>
						<input type="text" id="dataSend" value="10,20,30"/><br>
						<label text="text2">(Use comma between each byte if sending multiple bytes)</label><br>
						<button class="btn btn-primary" onclick="doUartSend()"id="id-btSend" disabled="true" >Send </button>	<br><br>

						<label for="id-dataReceived">Received data:</label><br>
						<textarea rows="5" cols="50" id="id-dataReceived" disabled>
							
						</textarea>					
					<tr>
				</div>
				
			</div>
						
			
		</div>
					
	
	</div>

    <div id="id-status" style="display:none">
        <div class="alert alert-success" role="alert">
            <span>
                <svg class="align-middle mr-2" style="fill:Green" focusable="false" width="24" height="24"
                     aria-hidden="true">
                    <path d="M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20, 12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10, 10 0 0,0 22,12A10, 10 0 0,0 12,2M11,17H13V11H11V17Z">
                    </path>
                </svg>
            </span>
            <span id="status-message"></span>
        </div>
    </div>

    <div id="id-error" style="display: none;">
        <div class="alert alert-danger" role="alert">
            <span>
                <svg class="align-middle mr-2" style="fill:red" focusable="false" width="24" height="24"
                     aria-hidden="true">
                    <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z">
                    </path>
                </svg>
            </span>
            <span id="error-message"></span>
        </div>
    </div>

</body>

</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    import("./src/serialweb/serialweb.js").then(mod => serial = mod);
    import("./src/duelink/duelink.js").then(mod => due = mod);
	import("./src/util.js").then(mod => util = mod);
	
	
	let isReading = false;		
	const intervalCallBack = 100;
	const textareaMaxCharacterPerLine = 55;
	const textareMaxLines = 5; //textarea rows="5" above

	
	function Check() {
        if (!this.duelink)
            this.duelink = new due.DUELinkController(new serial.WebSerial());
    }

    async function connect() {
        try {
            hideError();
            Check();
            await duelink.Connect();
            if (duelink.IsRave) {
                color_depth = 16;
                canvas.width = 160;
                canvas.height = 120;
                canvas.style.width = '320px';
                canvas.style.height = '240px';
            } else if (duelink.IsEdge) {
                await duelink.Display.Configuration(0, 0x3c);
            }
            $("#id-version").text(duelink.Version);
            $("#id-connect").slideUp();
            $("#id-btSend").prop("disabled", false);	
            $("#id-baudrate").prop("disabled", false);	
			
			document.getElementById("id-dataReceived").focus(); 
			document.getElementById("id-dataReceived").setSelectionRange(0, 0);

			await duelink.Uart.Enable(9600);	

			doActionCallback();
						
        } catch (e) {
            showError("connect Error" + e);
        }
    }
	
    async function ledOn() {
        Check();
        await duelink.Digital.Write('l', true);
    }

	async function ledOff() {
        Check();
        await duelink.Digital.Write('l', false);
    }
   
    async function buzzer() {
        Check();
        await duelink.Frequency.Write('p', 230, 1000);
    }

    
    function hideError() {
        $("#id-error").hide();
    }

    function showStatus(message) {
        $("#id-btSend").prop("disabled", true);
        $("#id-baudrate").prop("disabled", true);
        hideError();
        $("#id-status").show();
        $("#status-message").text(message);
        $.when($("#id-status").fadeOut(1000)).done(
            function () { $("#id-btSend").prop("disabled", false); $("#id-baudrate").prop("disabled", false);}
            
        );
    }

    function showError(message) {
        //$("#id-btSend").prop("disabled", true);
        //$("#id-baudrate").prop("disabled", true);
        $("#id-error").show();
        $("#error-message").text(message);
    }
	
	let isWriting = false;
	async function doUartSend() {
		hideError();

		const data = $("#dataSend").val().trim().split(",");			
		
		isWriting = true;
		for (let i = 0; i < data.length; i++) {
			
			var x = parseInt(data[i], 10);
			
			if (isNaN(x) == false) 
			{				
				await duelink.Uart.Write(x);
			}
			else  {				
				showError(`Error at index: ${i}, value: ${data[i]}` );
				
				break;
			}
			
		}
		isWriting =  false;
	}
	
	async function doUartInit() {
		await duelink.Uart.Enable($("#id-baudrate").val()/1);			
	}
		
	let receivedData = ""
	async function doActionCallback() {				
		try 
		{
			if (isReading == false && isWriting == false) {
				Check();
				isReading = true
				
				let available = await duelink.Uart.BytesToRead();
				
				for (let i = 0; i < available; i++) 
				{
					let data = await duelink.Uart.Read();
					
					if (receivedData.length != 0)
						receivedData +=","					
						
					if (receivedData.length > (textareaMaxCharacterPerLine * textareMaxLines - 4))
						receivedData = "";
						
					receivedData += data
						
					document.getElementById("id-dataReceived").innerHTML = receivedData
					
				}
				
				isReading = false
			}

			setTimeout(() => {
			  doActionCallback();
			}, intervalCallBack);	
		}
		catch (err){
			isReading = false
			showError("Error: " + err)			
		}
    }
		
</script>